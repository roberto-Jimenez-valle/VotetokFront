# ===============================================
# VOTETOK - QUICK SETUP SCRIPT
# Configura todo el entorno de desarrollo r√°pidamente
# ===============================================

Write-Host "===============================================" -ForegroundColor Cyan
Write-Host "  VOTETOK - CONFIGURACI√ìN R√ÅPIDA" -ForegroundColor Cyan
Write-Host "===============================================" -ForegroundColor Cyan
Write-Host ""

# Verificar requisitos
Write-Host "[1/10] Verificando requisitos..." -ForegroundColor Yellow

# Verificar Node.js
$nodeVersion = node --version 2>$null
if (-not $nodeVersion) {
    Write-Host "‚ùå Node.js no est√° instalado. Por favor instala Node.js 20+" -ForegroundColor Red
    exit 1
}
Write-Host "‚úÖ Node.js instalado: $nodeVersion" -ForegroundColor Green

# Verificar Docker
$dockerVersion = docker --version 2>$null
if (-not $dockerVersion) {
    Write-Host "‚ö†Ô∏è Docker no est√° instalado. Algunas funciones no estar√°n disponibles." -ForegroundColor Yellow
} else {
    Write-Host "‚úÖ Docker instalado: $dockerVersion" -ForegroundColor Green
}

# Verificar pnpm
$pnpmVersion = pnpm --version 2>$null
if (-not $pnpmVersion) {
    Write-Host "üì¶ Instalando pnpm..." -ForegroundColor Yellow
    npm install -g pnpm@8
}
Write-Host "‚úÖ pnpm instalado" -ForegroundColor Green

Write-Host ""

# Instalar dependencias
Write-Host "[2/10] Instalando dependencias..." -ForegroundColor Yellow
pnpm install --frozen-lockfile
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Error instalando dependencias" -ForegroundColor Red
    exit 1
}
Write-Host "‚úÖ Dependencias instaladas" -ForegroundColor Green

Write-Host ""

# Generar Prisma Client
Write-Host "[3/10] Generando Prisma Client..." -ForegroundColor Yellow
npx prisma generate
Write-Host "‚úÖ Prisma Client generado" -ForegroundColor Green

Write-Host ""

# Configurar archivo .env
Write-Host "[4/10] Configurando variables de entorno..." -ForegroundColor Yellow
if (-not (Test-Path ".env.local")) {
    Copy-Item ".env.example" ".env.local"
    Write-Host "‚úÖ Archivo .env.local creado (revisa y actualiza las variables)" -ForegroundColor Green
} else {
    Write-Host "‚úÖ Archivo .env.local ya existe" -ForegroundColor Green
}

Write-Host ""

# Levantar servicios Docker
if ($dockerVersion) {
    Write-Host "[5/10] Levantando servicios Docker..." -ForegroundColor Yellow
    
    # Verificar si docker-compose est√° corriendo
    $dockerRunning = docker ps 2>$null
    if ($dockerRunning) {
        Write-Host "üê≥ Iniciando PostgreSQL y Redis..." -ForegroundColor Cyan
        docker-compose up -d postgres redis
        
        # Esperar a que los servicios est√©n listos
        Write-Host "‚è≥ Esperando a que los servicios est√©n listos..." -ForegroundColor Yellow
        Start-Sleep -Seconds 10
        
        Write-Host "‚úÖ Servicios Docker levantados" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è Docker Desktop no est√° corriendo. In√≠cialo manualmente." -ForegroundColor Yellow
    }
} else {
    Write-Host "[5/10] Saltando Docker (no instalado)" -ForegroundColor Yellow
}

Write-Host ""

# Ejecutar migraciones
Write-Host "[6/10] Ejecutando migraciones de base de datos..." -ForegroundColor Yellow
$env:DATABASE_URL = "postgresql://voutop:voutop_pass@localhost:5432/voutop_db"

# Verificar conexi√≥n a BD
$canConnect = $false
try {
    npx prisma db push --skip-generate 2>$null
    $canConnect = $true
} catch {
    $canConnect = $false
}

if ($canConnect) {
    npx prisma migrate dev --name init
    Write-Host "‚úÖ Migraciones aplicadas" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è No se pudo conectar a la BD. Ejecuta las migraciones manualmente m√°s tarde." -ForegroundColor Yellow
}

Write-Host ""

# Aplicar √≠ndices optimizados
if ($canConnect -and (Test-Path "prisma/indexes-optimization.sql")) {
    Write-Host "[7/10] Aplicando √≠ndices optimizados..." -ForegroundColor Yellow
    # Aqu√≠ normalmente usar√≠as psql, pero en Windows es m√°s complejo
    Write-Host "‚ÑπÔ∏è Ejecuta manualmente: psql -U voutop -d voutop_db -f prisma/indexes-optimization.sql" -ForegroundColor Cyan
}

Write-Host ""

# Optimizar assets
Write-Host "[8/10] Optimizando assets..." -ForegroundColor Yellow
if (Test-Path "scripts/optimize-assets.mjs") {
    node scripts/optimize-assets.mjs
    Write-Host "‚úÖ Assets optimizados" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è Script de optimizaci√≥n no encontrado" -ForegroundColor Yellow
}

Write-Host ""

# Construir aplicaci√≥n
Write-Host "[9/10] Construyendo aplicaci√≥n..." -ForegroundColor Yellow
$buildChoice = Read-Host "¬øQuieres hacer build ahora? (s/n)"
if ($buildChoice -eq "s") {
    if (Test-Path "vite.config.optimized.js") {
        npm run build:optimized
    } else {
        npm run build
    }
    Write-Host "‚úÖ Build completado" -ForegroundColor Green
} else {
    Write-Host "‚ÑπÔ∏è Puedes hacer build m√°s tarde con: npm run build:optimized" -ForegroundColor Cyan
}

Write-Host ""

# Ejecutar tests
Write-Host "[10/10] Ejecutando tests..." -ForegroundColor Yellow
$testChoice = Read-Host "¬øQuieres ejecutar los tests? (s/n)"
if ($testChoice -eq "s") {
    npm run test:unit
    Write-Host "‚úÖ Tests ejecutados" -ForegroundColor Green
} else {
    Write-Host "‚ÑπÔ∏è Puedes ejecutar tests m√°s tarde con: npm test" -ForegroundColor Cyan
}

Write-Host ""
Write-Host "===============================================" -ForegroundColor Green
Write-Host "  ‚úÖ CONFIGURACI√ìN COMPLETADA" -ForegroundColor Green
Write-Host "===============================================" -ForegroundColor Green
Write-Host ""
Write-Host "üìù PR√ìXIMOS PASOS:" -ForegroundColor Cyan
Write-Host ""
Write-Host "  1. Revisa y actualiza .env.local con tus valores" -ForegroundColor White
Write-Host "  2. Ejecuta el servidor de desarrollo:" -ForegroundColor White
Write-Host "     npm run dev" -ForegroundColor Yellow
Write-Host ""
Write-Host "  3. Accede a la aplicaci√≥n en:" -ForegroundColor White
Write-Host "     http://localhost:5173" -ForegroundColor Yellow
Write-Host ""

if ($dockerVersion) {
    Write-Host "üìä SERVICIOS DISPONIBLES:" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "  ‚Ä¢ PostgreSQL: localhost:5432" -ForegroundColor White
    Write-Host "  ‚Ä¢ Redis: localhost:6379" -ForegroundColor White
    Write-Host "  ‚Ä¢ Redis Commander: http://localhost:8081" -ForegroundColor White
    Write-Host "  ‚Ä¢ pgAdmin: http://localhost:5050" -ForegroundColor White
    Write-Host ""
}

Write-Host "üìö DOCUMENTACI√ìN:" -ForegroundColor Cyan
Write-Host ""
Write-Host "  ‚Ä¢ Gu√≠a de implementaci√≥n: COMPLETE_IMPLEMENTATION_GUIDE.md" -ForegroundColor White
Write-Host "  ‚Ä¢ Informe de auditor√≠a: AUDIT_REPORT.md" -ForegroundColor White
Write-Host "  ‚Ä¢ Informe de refactorizaci√≥n: REFACTORING_COMPLETE_REPORT.md" -ForegroundColor White
Write-Host ""
Write-Host "Disfruta desarrollando con VouTop optimizado!" -ForegroundColor Green
