<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug M√≥vil - Geolocalizaci√≥n</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
      line-height: 1.6;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #10b981;
    }
    button {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
    }
    button:active {
      background: #059669;
    }
    .output {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #10b981;
    }
    .error {
      color: #ef4444;
    }
    .warning {
      color: #f59e0b;
    }
    .info {
      background: #1e40af;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì± Debug Geolocalizaci√≥n M√≥vil</h1>
    
    <div class="info">
      <strong>‚ö†Ô∏è Importante:</strong> Cuando pulses un bot√≥n, el navegador te pedir√° permiso para acceder a tu ubicaci√≥n. Debes <strong>PERMITIRLO</strong>.
    </div>

    <button onclick="testGPS()">üìç Probar GPS</button>
    <button onclick="testGeocode()">üåê Probar Geocoding</button>
    <button onclick="testFullVote()">üó≥Ô∏è Probar Voto Completo</button>
    <button onclick="clearOutput()">üßπ Limpiar</button>

    <div id="output" class="output"></div>
  </div>

  <script>
    const output = document.getElementById('output');

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      output.innerHTML += `[${timestamp}] ${prefix} ${msg}\n`;
      output.scrollTop = output.scrollHeight;
      console.log(msg);
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    async function testGPS() {
      clearOutput();
      log('Iniciando prueba de GPS...', 'info');
      
      if (!navigator.geolocation) {
        log('‚ùå navigator.geolocation NO disponible', 'error');
        log('Tu navegador no soporta geolocalizaci√≥n', 'error');
        return;
      }
      
      log('‚úÖ navigator.geolocation disponible', 'success');
      log('Solicitando posici√≥n...', 'info');
      log('(El navegador deber√≠a pedir permiso ahora)', 'warning');
      
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            timeout: 10000,
            maximumAge: 0,
            enableHighAccuracy: true
          });
        });
        
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const accuracy = position.coords.accuracy;
        
        log(`‚úÖ Ubicaci√≥n obtenida:`, 'success');
        log(`   Latitud: ${lat}`, 'success');
        log(`   Longitud: ${lon}`, 'success');
        log(`   Precisi√≥n: ${accuracy.toFixed(0)} metros`, 'success');
        
        return { lat, lon };
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        if (error.code === 1) {
          log('‚ö†Ô∏è Permiso DENEGADO', 'error');
          log('Ve a Configuraci√≥n del navegador y permite geolocalizaci√≥n', 'warning');
        } else if (error.code === 2) {
          log('‚ö†Ô∏è Posici√≥n NO DISPONIBLE', 'error');
        } else if (error.code === 3) {
          log('‚ö†Ô∏è TIMEOUT (tard√≥ demasiado)', 'error');
        }
        return null;
      }
    }

    async function testGeocode() {
      clearOutput();
      log('Probando geocoding completo...', 'info');
      
      const coords = await testGPS();
      if (!coords) return;
      
      log('\nüåê Llamando a API de geocoding...', 'info');
      
      try {
        const url = `/api/geocode?lat=${coords.lat}&lon=${coords.lon}`;
        log(`URL: ${url}`, 'info');
        
        const response = await fetch(url);
        log(`Status: ${response.status}`, response.ok ? 'success' : 'error');
        
        if (response.ok) {
          const data = await response.json();
          log('\n‚úÖ Respuesta del geocoding:', 'success');
          log(JSON.stringify(data, null, 2), 'info');
          
          if (data.subdivisionId) {
            log('\nüéâ ¬°subdivisionId detectado!', 'success');
            log(`   ${data.subdivisionName} (${data.subdivisionId})`, 'success');
          } else {
            log('\n‚ö†Ô∏è subdivisionId es NULL', 'warning');
          }
        } else {
          log(`‚ùå Error del servidor: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error de red: ${error.message}`, 'error');
      }
    }

    async function testFullVote() {
      clearOutput();
      log('üó≥Ô∏è Simulando voto completo...', 'info');
      
      const coords = await testGPS();
      if (!coords) return;
      
      log('\nüåê Obteniendo ubicaci√≥n...', 'info');
      
      try {
        const geocodeResponse = await fetch(`/api/geocode?lat=${coords.lat}&lon=${coords.lon}`);
        const geocodeData = await geocodeResponse.json();
        
        log('‚úÖ Ubicaci√≥n obtenida:', 'success');
        log(`   Pa√≠s: ${geocodeData.countryName}`, 'success');
        log(`   Subdivisi√≥n: ${geocodeData.subdivisionName || 'NULL'}`, geocodeData.subdivisionId ? 'success' : 'warning');
        
        const voteData = {
          optionId: 1,
          userId: 1,
          latitude: coords.lat,
          longitude: coords.lon,
          countryIso3: geocodeData.countryIso3,
          countryName: geocodeData.countryName,
          subdivisionId: geocodeData.subdivisionId,
          subdivisionName: geocodeData.subdivisionName,
          cityName: null
        };
        
        log('\nüì§ Enviando voto de prueba...', 'info');
        log('Datos:', 'info');
        log(JSON.stringify(voteData, null, 2), 'info');
        
        const voteResponse = await fetch('/api/polls/1/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(voteData)
        });
        
        log(`\nüì® Respuesta: ${voteResponse.status}`, voteResponse.ok ? 'success' : 'error');
        
        if (voteResponse.ok) {
          const result = await voteResponse.json();
          log('‚úÖ Voto guardado!', 'success');
          log(JSON.stringify(result, null, 2), 'success');
          
          if (result.vote.subdivisionId) {
            log('\nüéâ ¬°subdivisionId guardado correctamente!', 'success');
          } else {
            log('\n‚ö†Ô∏è subdivisionId es NULL en BD', 'warning');
          }
        } else {
          const error = await voteResponse.text();
          log(`‚ùå Error: ${error}`, 'error');
        }
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
