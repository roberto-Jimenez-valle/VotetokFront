name: Build Mobile Apps

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android APK'
        required: true
        type: boolean
        default: true
      build_ios:
        description: 'Build iOS IPA'
        required: true
        type: boolean
        default: true
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'ios/**'
      - 'src/**'
      - 'capacitor.config.ts'

permissions:
  contents: write

jobs:
  build-android:
    if: ${{ github.event.inputs.build_android == 'true' || github.event_name == 'push' }}
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Sync Capacitor
        run: npx cap sync android
      
      - name: Make gradlew executable
        working-directory: ./android
        run: chmod +x gradlew
      
      - name: Build Android APK
        working-directory: ./android
        run: ./gradlew assembleRelease
      
      - name: Sign APK
        if: ${{ env.KEYSTORE_FILE != '' }}
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          KEYSTORE_FILE: ${{ secrets.ANDROID_SIGNING_KEY }}
      
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

  build-ios:
    if: ${{ github.event.inputs.build_ios == 'true' || github.event_name == 'push' }}
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      
      - name: Sync Capacitor
        run: npx cap sync ios
      
      - name: Install CocoaPods dependencies
        working-directory: ./ios/App
        run: pod install
      
      - name: Build iOS Archive
        working-directory: ./ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $PWD/build/App.xcarchive \
            clean archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Create Unsigned IPA
        working-directory: ./ios/App
        run: |
          mkdir -p Payload
          cp -R build/App.xcarchive/Products/Applications/App.app Payload/
          zip -r App.ipa Payload
      
      - name: Upload iOS IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/App/App.ipa
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-android, build-ios]
    if: always() && (needs.build-android.result == 'success' || needs.build-ios.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Android APK
        if: needs.build-android.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts/android
      
      - name: Download iOS IPA
        if: needs.build-ios.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./artifacts/ios
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Automated build from commit ${{ github.sha }}
            
            ## Downloads
            ${{ needs.build-android.result == 'success' && '- Android APK (ready to install)' || '' }}
            ${{ needs.build-ios.result == 'success' && '- iOS IPA (unsigned)' || '' }}
          draft: false
          prerelease: false
          files: |
            ./artifacts/android/*.apk
            ./artifacts/ios/*.ipa
