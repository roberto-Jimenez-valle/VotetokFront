generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int                 @id @default(autoincrement())
  username        String              @unique
  email           String              @unique
  displayName     String              @map("display_name")
  avatarUrl       String?             @map("avatar_url")
  bio             String?
  role            String              @default("user")
  verified        Boolean             @default(false)
  countryIso3     String?             @map("country_iso3")
  subdivisionId   String?             @map("subdivision_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  isPrivate       Boolean             @default(false) @map("is_private")
  
  // Campos de seguridad anti-bot
  isBanned        Boolean             @default(false) @map("is_banned")
  banReason       String?             @map("ban_reason")
  bannedAt        DateTime?           @map("banned_at")
  isShadowbanned  Boolean             @default(false) @map("is_shadowbanned")
  isSuspect       Boolean             @default(false) @map("is_suspect")
  suspectScore    Int                 @default(0) @map("suspect_score")  // Puntuación de sospecha acumulada
  lastActiveAt    DateTime?           @map("last_active_at")
  
  notifications   Notification[]      @relation("UserNotifications")
  sentNotifications Notification[]    @relation("NotificationActor")
  comments        Comment[]
  featuredProfile FeaturedUser?
  interactions    PollInteraction[]
  createdOptions  PollOption[]        @relation("OptionCreator")
  polls           Poll[]              @relation("PollCreator")
  followers       UserFollower[]      @relation("UserFollowers")
  following       UserFollower[]      @relation("UserFollowing")
  hashtagFollows  UserHashtagFollow[]
  interests       UserInterest[]
  votes           Vote[]
  pollDrafts      PollDraft[]
  collaborations  PollCollaborator[]
  conversationParticipations ConversationParticipant[]
  sentMessages    Message[]
  consent         UserConsent?
  reportsCreated  Report[]            @relation("ReportCreator")
  reportsReviewed Report[]            @relation("ReportReviewer")

  @@index([username])
  @@index([countryIso3])
  @@index([createdAt])
  @@map("users")
}

model Poll {
  id              Int               @id @default(autoincrement())
  userId          Int               @map("user_id")
  title           String
  description     String?
  category        String?
  imageUrl        String?           @map("image_url")
  type            String            @default("standard")
  status          String            @default("active")
  visibility      String            @default("public")  // public, followers, mutuals
  collabMode      String            @default("me") @map("collab_mode") // me, public, mutuals, selected
  isRell          Boolean           @default(false) @map("is_rell")
  originalPollId  Int?              @map("original_poll_id")
  correctOptionId Int?              @map("correct_option_id")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  closedAt       DateTime?         @map("closed_at")
  isHidden       Boolean           @default(false) @map("is_hidden") // Auto-ocultar por reportes
  comments       Comment[]
  hashtags       PollHashtag[]
  interactions   PollInteraction[]
  options        PollOption[]
  collaborators  PollCollaborator[]
  originalPoll   Poll?             @relation("PollRells", fields: [originalPollId], references: [id])
  rells          Poll[]            @relation("PollRells")
  user           User              @relation("PollCreator", fields: [userId], references: [id], onDelete: Cascade)
  history        VoteHistory[]
  votes          Vote[]
  reports        Report[] @relation("PollReports")

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([type])
  @@index([visibility])
  @@index([collabMode])
  @@index([isRell])
  @@index([originalPollId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("polls")
}

model PollCollaborator {
  id        Int      @id @default(autoincrement())
  pollId    Int      @map("poll_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId])
  @@index([pollId])
  @@map("poll_collaborators")
}

model PollOption {
  id           Int           @id @default(autoincrement())
  pollId       Int           @map("poll_id")
  optionKey    String        @map("option_key")
  optionLabel  String        @map("option_label")
  color        String
  displayOrder Int           @default(0) @map("display_order")
  createdById  Int?          @map("created_by_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  imageUrl     String?       @map("image_url")
  createdBy    User?         @relation("OptionCreator", fields: [createdById], references: [id])
  poll         Poll          @relation(fields: [pollId], references: [id], onDelete: Cascade)
  history      VoteHistory[]
  votes        Vote[]

  @@unique([pollId, optionKey])
  @@index([pollId])
  @@index([createdById])
  @@index([pollId, displayOrder])
  @@index([pollId, displayOrder], map: "idx_poll_options_poll_display")
  @@map("poll_options")
}

model Vote {
  id            Int          @id @default(autoincrement())
  pollId        Int          @map("poll_id")
  optionId      Int          @map("option_id")
  userId        Int?         @map("user_id")
  latitude      Float
  longitude     Float
  subdivisionId Int?         @map("subdivision_id")
  ipAddress     String?      @map("ip_address")
  userAgent     String?      @map("user_agent")
  createdAt     DateTime     @default(now()) @map("created_at")
  option        PollOption   @relation(fields: [optionId], references: [id], onDelete: Cascade)
  poll          Poll         @relation(fields: [pollId], references: [id], onDelete: Cascade)
  subdivision   Subdivision? @relation(fields: [subdivisionId], references: [id], onDelete: Restrict)
  user          User?        @relation(fields: [userId], references: [id])

  @@index([optionId])
  @@index([userId])
  @@index([pollId])
  @@index([pollId, userId])
  @@index([pollId, ipAddress])
  @@index([subdivisionId])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@map("votes")
}

model PollInteraction {
  id              Int      @id @default(autoincrement())
  pollId          Int      @map("poll_id")
  userId          Int?     @map("user_id")
  interactionType String   @map("interaction_type")
  ipAddress       String?  @map("ip_address")
  createdAt       DateTime @default(now()) @map("created_at")
  poll            Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId, interactionType])
  @@index([pollId])
  @@index([userId])
  @@index([ipAddress])
  @@map("poll_interactions")
}

model Comment {
  id              Int       @id @default(autoincrement())
  pollId          Int       @map("poll_id")
  userId          Int       @map("user_id")
  parentCommentId Int?      @map("parent_comment_id")
  content         String
  likesCount      Int       @default(0) @map("likes_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  parentComment   Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  poll            Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports         Report[] @relation("CommentReports")

  @@index([pollId])
  @@index([userId])
  @@map("comments")
}

model FeaturedUser {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique @map("user_id")
  roleTitle      String?  @map("role_title")
  citationsCount Int      @default(0) @map("citations_count")
  displaySize    Int      @default(30) @map("display_size")
  highlightColor String?  @map("highlight_color")
  featuredOrder  Int      @default(0) @map("featured_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("featured_users")
}

model UserFollower {
  id          Int      @id @default(autoincrement())
  followerId  Int      @map("follower_id")
  followingId Int      @map("following_id")
  status      String   @default("accepted")
  createdAt   DateTime @default(now()) @map("created_at")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_followers")
}

model VoteHistory {
  id         Int        @id @default(autoincrement())
  pollId     Int        @map("poll_id")
  optionId   Int        @map("option_id")
  voteCount  Int        @map("vote_count")
  percentage Float
  recordedAt DateTime   @default(now()) @map("recorded_at")
  option     PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  poll       Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@index([pollId])
  @@index([recordedAt])
  @@map("vote_history")
}

model Hashtag {
  id          Int                 @id @default(autoincrement())
  tag         String              @unique
  usageCount  Int                 @default(0) @map("usage_count")
  createdAt   DateTime            @default(now()) @map("created_at")
  polls       PollHashtag[]
  userFollows UserHashtagFollow[]

  @@map("hashtags")
}

model PollHashtag {
  pollId    Int     @map("poll_id")
  hashtagId Int     @map("hashtag_id")
  hashtag   Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  poll      Poll    @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@id([pollId, hashtagId])
  @@map("poll_hashtags")
}

model UserInterest {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  category  String
  score     Float    @default(1.0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
  @@map("user_interests")
}

model UserHashtagFollow {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  hashtagId Int      @map("hashtag_id")
  createdAt DateTime @default(now()) @map("created_at")
  hashtag   Hashtag  @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hashtagId])
  @@index([userId])
  @@index([hashtagId])
  @@map("user_hashtag_follows")
}

model Subdivision {
  id            Int      @id @default(autoincrement())
  subdivisionId String   @unique @map("subdivision_id")
  level         Int
  level1Id      String?  @map("level1_id")
  level2Id      String?  @map("level2_id")
  level3Id      String?  @map("level3_id")
  name          String
  nameLocal     String?  @map("name_local")
  nameVariant   String?  @map("name_variant")
  typeEnglish   String?  @map("type_english")
  hasc          String?
  iso           String?
  countryCode   String?  @map("country_code")
  latitude      Float
  longitude     Float
  createdAt     DateTime @default(now()) @map("created_at")
  isLowestLevel Boolean  @default(false) @map("is_lowest_level")
  votes         Vote[]

  @@index([level])
  @@index([subdivisionId])
  @@index([latitude, longitude])
  @@index([level, latitude, longitude])
  @@map("subdivisions")
}

model PollDraft {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  draftData   Json     @map("draft_data") // Guarda todo el contenido del borrador como JSON
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("poll_drafts")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id") // Receptor
  actorId   Int?     @map("actor_id") // Emisor
  type      String   // FOLLOW_REQUEST, NEW_FOLLOWER, etc
  message   String?
  read      Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  actor     User?    @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model Conversation {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  conversationId Int @map("conversation_id")
  userId         Int @map("user_id")
  unreadCount    Int @default(0) @map("unread_count")
  joinedAt       DateTime @default(now()) @map("joined_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int      @map("conversation_id")
  senderId       Int      @map("sender_id")
  content        String
  createdAt      DateTime @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// Modelo para almacenar consentimientos GDPR del usuario
model UserConsent {
  id                  Int      @id @default(autoincrement())
  userId              Int      @unique @map("user_id")
  
  // Verificación de edad
  isOver16            Boolean  @default(false) @map("is_over_16")
  ageVerifiedAt       DateTime? @map("age_verified_at")
  
  // Aceptación de términos legales
  termsAccepted       Boolean  @default(false) @map("terms_accepted")
  termsAcceptedAt     DateTime? @map("terms_accepted_at")
  termsVersion        String?  @map("terms_version") // Para trackear versión de términos
  
  // Aceptación de política de privacidad
  privacyAccepted     Boolean  @default(false) @map("privacy_accepted")
  privacyAcceptedAt   DateTime? @map("privacy_accepted_at")
  privacyVersion      String?  @map("privacy_version")
  
  // Consentimiento de cookies
  cookiesEssential    Boolean  @default(true) @map("cookies_essential") // Siempre true
  cookiesAnalytics    Boolean  @default(false) @map("cookies_analytics")
  cookiesAdvertising  Boolean  @default(false) @map("cookies_advertising")
  cookiesConsentAt    DateTime? @map("cookies_consent_at")
  
  // Metadatos
  ipAddress           String?  @map("ip_address")
  userAgent           String?  @map("user_agent")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("user_consents")
}

// ============================================
// CHECKLIST DE PRODUCCIÓN
// ============================================

model ChecklistGroup {
  id          Int             @id @default(autoincrement())
  title       String
  icon        String          @default("Zap")
  color       String          @default("text-gray-500")
  displayOrder Int            @default(0) @map("display_order")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  items       ChecklistItem[]
  
  @@index([displayOrder])
  @@map("checklist_groups")
}

model ChecklistItem {
  id          Int             @id @default(autoincrement())
  groupId     Int             @map("group_id")
  label       String
  status      String          @default("missing") // done, partial, missing
  detail      String?
  note        String?
  action      String?
  critical    Boolean         @default(false)
  displayOrder Int            @default(0) @map("display_order")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  group       ChecklistGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@index([groupId])
  @@index([status])
  @@index([displayOrder])
  @@map("checklist_items")
}

// ============================================
// SISTEMA DE REPORTES
// ============================================

model Report {
  id          Int       @id @default(autoincrement())
  pollId      Int       @map("poll_id")
  commentId   Int?      @map("comment_id") 
  userId      Int       @map("user_id")
  reason      String    // spam, inappropriate, misleading, hate, other
  notes       String?   // Notas adicionales del usuario
  status      String    @default("pending") // pending, reviewed, dismissed, actioned
  reviewedBy  Int?      @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewNotes String?   @map("review_notes")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  poll        Poll      @relation("PollReports", fields: [pollId], references: [id], onDelete: Cascade)
  comment     Comment?  @relation("CommentReports", fields: [commentId], references: [id], onDelete: Cascade)
  user        User      @relation("ReportCreator", fields: [userId], references: [id], onDelete: Cascade)
  reviewer    User?     @relation("ReportReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  @@unique([pollId, userId, commentId]) // Un usuario solo puede reportar la misma cosa una vez
  @@index([pollId])
  @@index([commentId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}
